openapi: 3.0.3
info:
  title: myTrack API
  description: |-
    This document provides a detailed overview of the myTrack REST API.
    The API is used to manage IMEI-related resources, journeys, users, and other assets.
  version: 0.7.2-SNAPSHOT
servers:
  - url: https://thkrebs.ddns.net:8443/api/v1
    description: Production Server
  - url: http://localhost:8080/api/v1
    description: Local Development Server
tags:
  - name: User
    description: Endpoints for managing user features and settings.
  - name: Journey
    description: Endpoints for creating, managing, and retrieving journey data.
  - name: ParkSpot
    description: Endpoints for finding and managing parking spots.
  - name: Authentication
    description: Endpoints for user authentication and token management.
  - name: Imei
    description: Endpoints for managing IMEI devices.
  - name: Position
    description: Endpoints for retrieving position data.
  - name: API Token
    description: Endpoints for managing API tokens.

paths:
  # Authentication Controller
  /authenticate:
    post:
      tags:
        - Authentication
      summary: Authenticate User
      description: Authenticates a user with a username and password and returns a JWT.
      operationId: authenticateUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthenticationRequest'
      responses:
        '200':
          description: Authentication successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthenticationResponse'
        '401':
          description: Invalid credentials

  /refresh-token:
    post:
      tags:
        - Authentication
      summary: Refresh Authentication Token
      description: Obtains a new JWT using a valid, non-expired refresh token.
      operationId: refreshToken
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshTokenRequest'
      responses:
        '200':
          description: Token refreshed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthenticationResponse'
        '401':
          description: Invalid or expired refresh token

  # User Controller
  /user/{username}/features:
    get:
      tags:
        - User
      summary: Get User Features
      description: Retrieves the feature flags for a specific user. The feature field is a 64-bit integer that encodes the user's domain and subscribed packages.
      operationId: getUserFeatures
      parameters:
        - name: username
          in: path
          required: true
          schema:
            type: string
          description: The username of the user whose features are to be retrieved.
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserFeaturesDTO'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: User not found
      security:
        - bearerAuth: []

  /user/{username}/profile:
    get:
      tags:
        - User
      summary: Get User Profile
      description: Retrieves the full profile of a user. Accessible by the user themselves or an admin.
      operationId: getUserProfile
      parameters:
        - name: username
          in: path
          required: true
          schema:
            type: string
          description: The username of the user whose profile is to be retrieved.
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfileDTO'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: User not found
      security:
        - bearerAuth: []
    put:
      tags:
        - User
      summary: Update User Profile
      description: Updates the user's own profile (username and email only). Accessible only by the user themselves.
      operationId: updateUserProfile
      parameters:
        - name: username
          in: path
          required: true
          schema:
            type: string
          description: The username of the user whose profile is to be updated.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserProfileUpdateDTO'
      responses:
        '200':
          description: Profile updated successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfileDTO'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: User not found
      security:
        - bearerAuth: []

  /user/{username}/admin/profile:
    put:
      tags:
        - User
      summary: Admin Update User Profile
      description: Updates the full user profile, including features and enabled status. Accessible only by admins (GOD role).
      operationId: adminUpdateUserProfile
      parameters:
        - name: username
          in: path
          required: true
          schema:
            type: string
          description: The username of the user whose profile is to be updated.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserProfileAdminUpdateDTO'
      responses:
        '200':
          description: Profile updated successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfileDTO'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: User not found
      security:
        - bearerAuth: []

  /user/resetPassword:
    post:
      tags:
        - User
      summary: Request Password Reset
      description: Initiates the password reset process by sending an email with a reset token to the user.
      operationId: resetPassword
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PasswordResetRequestDTO'
      responses:
        '200':
          description: Password reset email sent (if user exists).
          content:
            text/plain:
              schema:
                type: string
                example: "If an account with that email exists, a password reset link has been sent."

  /user/savePassword:
    post:
      tags:
        - User
      summary: Save New Password
      description: Updates the user's password using a valid reset token.
      operationId: savePassword
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PasswordSaveRequestDTO'
      responses:
        '200':
          description: Password updated successfully.
          content:
            text/plain:
              schema:
                type: string
                example: "Password reset successfully."
        '400':
          description: Invalid or expired token.

  # Journey Controller
  /journeys/user/{username}:
    get:
      tags:
        - Journey
      summary: Get All Journeys for User
      description: Retrieves a list of all journeys for a specific user.
      operationId: getJourneysForUser
      parameters:
        - name: username
          in: path
          required: true
          schema:
            type: string
          description: The username of the user whose journeys are to be retrieved.
      responses:
        '200':
          description: A list of the user's journeys.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/JourneyDTO'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: User not found
      security:
        - bearerAuth: []
  /journeys/user/{username}/active:
    get:
      tags:
        - Journey
      summary: Get Active Journey for User
      description: Retrieves the currently active journey for a specific user. An active journey has a start date but no end date.
      operationId: getActiveJourneyForUser
      parameters:
        - name: username
          in: path
          required: true
          schema:
            type: string
          description: The username of the user whose active journey is to be retrieved.
      responses:
        '200':
          description: Active journey found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JourneyDTO'
        '204':
          description: No active journey found for the user.
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: User not found
      security:
        - bearerAuth: []

  /journeys:
    post:
      tags:
        - Journey
      summary: Create Journey
      description: Creates a new journey. The authenticated user will be set as the owner.
      operationId: createJourney
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateJourneyDTO'
      responses:
        '201':
          description: Journey created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JourneyDTO'
        '401':
          description: Unauthorized
      security:
        - bearerAuth: []

  /journeys/{id}:
    get:
      tags:
        - Journey
      summary: Get Journey by ID
      description: Retrieves a single journey by its unique ID.
      operationId: getJourneyById
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JourneyDTO'
        '403':
          description: Forbidden
        '404':
          description: Journey not found
      security:
        - bearerAuth: []
    put:
      tags:
        - Journey
      summary: Update Journey
      description: Updates an existing journey by its ID.
      operationId: updateJourney
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateJourneyDTO'
      responses:
        '200':
          description: Journey updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JourneyDTO'
        '403':
          description: Forbidden
        '404':
          description: Journey not found
      security:
        - bearerAuth: []
    patch:
      tags:
        - Journey
      summary: Patch Journey
      description: Partially updates an existing journey by its ID. Only non-null fields in the request body will be updated.
      operationId: patchJourney
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JourneyPatchDTO'
      responses:
        '200':
          description: Journey updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JourneyDTO'
        '403':
          description: Forbidden
        '404':
          description: Journey not found
      security:
        - bearerAuth: []
    delete:
      tags:
        - Journey
      summary: Delete Journey
      description: Deletes a journey by its ID.
      operationId: deleteJourney
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '204':
          description: Journey deleted successfully
        '403':
          description: Forbidden
        '404':
          description: Journey not found
      security:
        - bearerAuth: []

  /journeys/{journeyId}/overnight-parking:
    post:
      tags:
        - Journey
      summary: Create Overnight Parking Spot
      description: Creates an overnight parking spot for a specific journey based on the last known position of the active tracker.
      operationId: createOvernightParkingForJourney
      parameters:
        - name: journeyId
          in: path
          required: true
          schema:
            type: integer
            format: int64
        - name: name
          in: query
          required: true
          schema:
            type: string
          description: The name of the parking spot.
        - name: description
          in: query
          required: false
          schema:
            type: string
          description: An optional description of the parking spot.
        - name: createWPPost
          in: query
          required: false
          schema:
            type: boolean
            default: false
          description: Whether to create a corresponding post in WordPress.
        - name: date
          in: query
          required: false
          schema:
            type: string
            format: date
          description: The date of the overnight stay. Defaults to the current date if not provided.
      responses:
        '201':
          description: Overnight parking spot created successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ParkSpotDTO'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Journey not found.
      security:
        - bearerAuth: []

  /journeys/{journeyId}/overnight-parkings:
    get:
      tags:
        - Journey
      summary: Get All Overnight Parkings for a Journey
      description: Retrieves a list of all overnight parking spots associated with a specific journey.
      operationId: getOvernightParkingsForJourney
      parameters:
        - name: journeyId
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: A list of parking spots.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ParkSpotDTO'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Journey not found
      security:
        - bearerAuth: []

  /journeys/{journeyId}/nearbyOvernight-parking:
    get:
      tags:
        - Journey
      summary: Get Nearby Overnight Parking Spots
      description: Retrieves park spots near the journey's path, including the last park date if available.
      operationId: getNearbyOvernightParkingForJourney
      parameters:
        - name: journeyId
          in: path
          required: true
          schema:
            type: integer
            format: int64
        - name: distance
          in: query
          required: false
          schema:
            type: integer
            format: int64
            default: 50
          description: The search radius in meters.
      responses:
        '200':
          description: A list of nearby parking spots with park dates.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ParkSpotWithDateDTO'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Journey not found
      security:
        - bearerAuth: []

  /journeys/{journeyId}/track:
    get:
      tags:
        - Journey
      summary: Get Journey Track
      description: Retrieves the track of a journey as a GeoJSON FeatureCollection.
      operationId: getJourneyTrack
      parameters:
        - name: journeyId
          in: path
          required: true
          schema:
            type: integer
            format: int64
        - name: from
          in: query
          required: false
          schema:
            type: string
            format: date-time
          description: Start date/time for the track filter.
        - name: to
          in: query
          required: false
          schema:
            type: string
            format: date-time
          description: End date/time for the track filter.
        - name: conceal
          in: query
          required: false
          schema:
            type: boolean
          description: Whether to conceal the last known position. Defaults to true for active journeys.
      responses:
        '200':
          description: A GeoJSON FeatureCollection representing the journey track.
          content:
            application/json:
              schema:
                type: object # GeoJSON FeatureCollection
        '403':
          description: Forbidden
        '404':
          description: Journey not found
      security:
        - bearerAuth: []
        - apiTokenAuth: [] # Assuming API token can also be used

  # ParkSpot Controller
  /parkspots/nearby:
    get:
      tags:
        - ParkSpot
      summary: Find ParkSpots Nearby
      description: Retrieves all parking spots within a given distance from a specified geographical point.
      operationId: getNearbyParkSpots
      parameters:
        - name: longitude
          in: query
          required: true
          schema:
            type: number
            format: double
          description: The longitude of the center point for the search.
        - name: latitude
          in: query
          required: true
          schema:
            type: number
            format: double
          description: The latitude of the center point for the search.
        - name: distance
          in: query
          required: false
          schema:
            type: number
            format: double
            default: 1000
          description: The search radius in meters.
      responses:
        '200':
          description: A list of nearby parking spots.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ParkSpotDTO'

  # Imei Controller
  /imeis:
    get:
      tags:
        - Imei
      summary: Get All IMEIs
      description: Retrieves a list of all IMEI devices. Requires GOD role.
      operationId: getAllImeis
      responses:
        '200':
          description: A list of IMEI devices.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ImeiDTO'
        '403':
          description: Forbidden
      security:
        - bearerAuth: []

  # Position Controller
  /positions/{imei}/last:
    get:
      tags:
        - Position
      summary: Get Last Known Position
      description: Retrieves the last known position for a specific IMEI device.
      operationId: getLastPosition
      parameters:
        - name: imei
          in: path
          required: true
          schema:
            type: string
          description: The IMEI number of the device.
      responses:
        '200':
          description: The last known position of the device.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PositionDTO'
        '403':
          description: Forbidden
        '404':
          description: IMEI or Position not found
      security:
        - bearerAuth: []

  # ApiToken Controller (Placeholder)
  /api-tokens:
    post:
      tags:
        - API Token
      summary: Create API Token
      description: Generates a new API token for programmatic access. (Details TBD)
      operationId: createApiToken
      responses:
        '201':
          description: API Token created.
      security:
        - bearerAuth: []

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
    apiTokenAuth: # Placeholder for API token security
      type: apiKey
      in: header
      name: X-API-KEY

  schemas:
    # DTOs
    UserFeaturesDTO:
      type: object
      properties:
        domain:
          type: integer
          format: int32
          description: The domain identifier for the user.
        packages:
          type: integer
          format: int32
          description: The package identifier for the user.
    UserProfileDTO:
      type: object
      properties:
        username:
          type: string
        email:
          type: string
          format: email
        createdAt:
          type: string
          format: date-time
          description: Creation timestamp (yyyy-MM-dd HH:mm:ss)
        features:
          type: integer
          format: int64
        enabled:
          type: boolean
    UserProfileUpdateDTO:
      type: object
      required:
        - username
        - email
      properties:
        username:
          type: string
        email:
          type: string
          format: email
    UserProfileAdminUpdateDTO:
      type: object
      required:
        - username
        - email
      properties:
        username:
          type: string
        email:
          type: string
          format: email
        features:
          type: integer
          format: int64
        enabled:
          type: boolean
    JourneyDTO:
      type: object
      properties:
        id:
          type: integer
          format: int64
        name:
          type: string
        description:
          type: string
        startDate:
          type: string
          format: date
        endDate:
          type: string
          format: date
        ownerId:
          type: integer
          format: int64
        trackedByImeis:
          type: array
          items:
            $ref: '#/components/schemas/ImeiSlimDTO'
    CreateJourneyDTO:
      type: object
      required:
        - name
      properties:
        name:
          type: string
        description:
          type: string
        startDate:
          type: string
          format: date
        endDate:
          type: string
          format: date
    JourneyPatchDTO:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        startDate:
          type: string
          format: date
        endDate:
          type: string
          format: date
        trackedByImeis:
          type: array
          items:
            type: integer
            format: int64
    ImeiDTO:
      type: object
      properties:
        id:
          type: integer
          format: int64
        imei:
          type: string
        active:
          type: boolean
        ownerId:
          type: integer
          format: int64
    ImeiSlimDTO:
      type: object
      properties:
        id:
          type: integer
          format: int64
        imei:
          type: string
    PositionDTO:
      type: object
      properties:
        latitude:
          type: number
          format: double
        longitude:
          type: number
          format: double
        timestamp:
          type: string
          format: date-time
        altitude:
          type: number
          format: double
        speed:
          type: number
          format: double
    ParkSpotDTO:
      type: object
      properties:
        id:
          type: integer
          format: int64
        name:
          type: string
        description:
          type: string
        latitude:
          type: number
          format: double
        longitude:
          type: number
          format: double
    ParkSpotWithDateDTO:
      allOf:
        - $ref: '#/components/schemas/ParkSpotDTO'
        - type: object
          properties:
            parkDate:
              type: string
              format: date
              description: The latest date the user parked at this spot during the journey.

    # Request/Response Bodies
    AuthenticationRequest:
      type: object
      required:
        - username
        - password
      properties:
        username:
          type: string
        password:
          type: string
    AuthenticationResponse:
      type: object
      properties:
        token:
          type: string
    RefreshTokenRequest:
      type: object
      required:
        - refreshToken
      properties:
        refreshToken:
          type: string
    PasswordResetRequestDTO:
      type: object
      required:
        - email
      properties:
        email:
          type: string
          format: email
    PasswordSaveRequestDTO:
      type: object
      required:
        - token
        - newPassword
      properties:
        token:
          type: string
        newPassword:
          type: string